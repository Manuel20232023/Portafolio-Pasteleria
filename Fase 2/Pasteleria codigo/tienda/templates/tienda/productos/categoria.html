{% extends 'tienda/base_store.html' %}
{% load static %}
{% block title %}{{ categoria_nombre }} - Sweet Blessing{% endblock %}

{% block extra_head %}
<style>
  .hero-cat {
    position: relative;
    overflow: hidden;
    border-radius: .5rem;
  }
  .hero-cat img {
    width: 100%;
    height: 260px;
    object-fit: cover;
    display: block;
  }
  .hero-cat .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.6));
  }
  .hero-cat h2 {
    position: absolute;
    bottom: 12px;
    left: 16px;
    color: #fff;
    margin: 0;
    text-shadow: 0 1px 2px rgba(0,0,0,.5);
  }
  .card-img-top {
    height: 220px;
    object-fit: cover;
  }
</style>
{% endblock %}

{% block content %}
  {% comment %}
    Normalizamos nombres por si la vista antigua usa 'categoria'
  {% endcomment %}
  {% with slug_val=categoria_slug|default_if_none:'' name_val=categoria_nombre|default_if_none:'Categoría' %}

  <!-- Hero de categoría -->
  <div class="hero-cat mb-3">
    <img
      src="{% static 'tienda/img/categorias/hero_' %}{{ slug_val }}.jpg"
      alt="{{ name_val }}"
      onerror="
        if(!this.dataset.fallback1){
          this.dataset.fallback1 = 1;
          this.src = '{% static 'tienda/img/categorias/' %}{{ slug_val }}.jpg';
        } else if(!this.dataset.fallback2){
          this.dataset.fallback2 = 1;
          this.src = '{% static 'tienda/img/categorias/' %}{{ slug_val }}.png';
        } else {
          this.onerror = null;
          this.src = '{% static 'tienda/img/categorias/default.jpg' %}';
        }
      "
    >
    <div class="overlay"></div>
    <h2>{{ name_val }}</h2>
  </div>

  <!-- Navegación superior -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'tienda:productos' %}" class="btn btn-primary">Ver categorías</a>
    <form class="d-none d-md-flex" action="{% url 'tienda:buscar' %}">
      <input class="form-control" type="search" name="q" placeholder="Buscar en el catálogo">
    </form>
  </div>

  <!-- Grilla de productos -->
  <div class="row g-3">
    {% for p in productos %}
      <div class="col-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <img src="{% static p.imagen %}" class="card-img-top" alt="{{ p.nombre }}">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title">{{ p.nombre }}</h6>
            <p class="mb-3">${{ p.precio }}</p>
            <a href="{% url 'tienda:carrito_agregar' p.id %}" class="btn btn-primary mt-auto">Agregar</a>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay productos en esta categoría.</p>
    {% endfor %}
  </div>

  {% endwith %}
{% endblock %}
